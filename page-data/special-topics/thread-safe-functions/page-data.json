{"componentChunkName":"component---src-templates-page-tsx","path":"/special-topics/thread-safe-functions/","result":{"data":{"site":{"siteMetadata":{"title":"The Node-API Resource","description":"Tutorials and more for Node.js Node-API.","siteUrl":"https://github.com/nodejs/node-addon-examples","keywords":"node nodejs n-api napi tutorials native-addon","author":{"name":"The Node-API Team","url":"https://github.com/nodejs/node-addon-examples","email":""}}},"sectionList":{"edges":[{"node":{"title":"About Node-API","items":[{"id":"about.what","slug":"/about/what","title":"What is Node-API?"},{"id":"about.uses","slug":"/about/uses","title":"Uses for Node-API"}]}},{"node":{"title":"Getting Started","items":[{"id":"getting-started.prerequisites","slug":"/getting-started/prerequisites","title":"Prerequisites"},{"id":"getting-started.tools","slug":"/getting-started/tools","title":"The tools you'll need"},{"id":"getting-started.first","slug":"/getting-started/first","title":"A first project"},{"id":"getting-started.objectwrap","slug":"/getting-started/objectwrap","title":"Object wrap"},{"id":"getting-started.migration","slug":"/getting-started/migration","title":"Migration tutorial"}]}},{"node":{"title":"Build Tools","items":[{"id":"build-tools.node-gyp","slug":"/build-tools/node-gyp","title":"node-gyp"},{"id":"build-tools.cmake-js","slug":"/build-tools/cmake-js","title":"CMake.js"},{"id":"build-tools.node-pre-gyp","slug":"/build-tools/node-pre-gyp","title":"node-pre-gyp"},{"id":"build-tools.prebuild","slug":"/build-tools/prebuild","title":"prebuild"}]}},{"node":{"title":"Special Topics","items":[{"id":"special-topics.object-function-refs","slug":"/special-topics/object-function-refs","title":"Object & function refs"},{"id":"special-topics.asyncworker","slug":"/special-topics/asyncworker","title":"AsyncWorker"},{"id":"special-topics.thread-safe-functions","slug":"/special-topics/thread-safe-functions","title":"Thread-safe functions"},{"id":"special-topics.context-awareness","slug":"/special-topics/context-awareness","title":"Context awareness"}]}}]},"markdownRemark":{"htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"JavaScript functions can normally only be called from a native addon’s main thread. If an addon creates additional threads, then node-addon-api functions that require a "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Napi::Env"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Napi::Value"}]},{"type":"text","value":", or "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Napi::Reference"}]},{"type":"text","value":" must not be called from those threads."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When an addon has additional threads and JavaScript functions need to be invoked based on the processing completed by those threads, those threads must communicate with the addon’s main thread so that the main thread can invoke the JavaScript function on their behalf. The thread-safe function APIs provide an easy way to do this."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A thread-safe function is created on the main thread via "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/nodejs/node-addon-api/blob/main/doc/threadsafe_function.md#new"},"children":[{"type":"text","value":"ThreadSafeFunction::New"}]},{"type":"text","value":":"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"cpp"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-cpp"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-cpp"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"New"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"napi_env env"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" Function"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"&"}]},{"type":"text","value":" callback"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" Object"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"&"}]},{"type":"text","value":" resource"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    ResourceString resourceName"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    size_t maxQueueSize"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    size_t initialThreadCount"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    ContextType"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"*"}]},{"type":"text","value":" context"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    Finalizer finalizeCallback"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n    FinalizerDataType"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"*"}]},{"type":"text","value":" data"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A thread-safe function encapsulates:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Message queue: Requests to run the JavaScript function are placed in a queue, processed asynchronously by the main thread. The amount of entries allowed in the queue before returning a “queue full” error on "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"NonBlockingCall()"}]},{"type":"text","value":" is controlled via the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"maxQueueSize"}]},{"type":"text","value":" parameter (specify "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":" for unlimited queue)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"JavaScript function: Callback to run ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"callback"}]},{"type":"text","value":" parameter). This function is either (a) automatically ran with no arguments when called via the no-argument "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[Non]BlockingCall()"}]},{"type":"text","value":" overloads, or (b) passed as an argument to the callback function provided in the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[Non]BlockingCall(DataType* data, Callback callback)"}]},{"type":"text","value":" overloads."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Context: Optional, arbitrary data ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"context"}]},{"type":"text","value":" parameter) to associate with the thread-safe function."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Finalizer: Optional callback ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"finalizeCallback"}]},{"type":"text","value":" parameter) to run at destruction of the thread-safe function, when all threads have finished using it."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Finalizer data: Optional data ("},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"data"}]},{"type":"text","value":" parameter) to provide to the finalizer callback."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"calling-the-thread-safe-function","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#calling-the-thread-safe-function","ariaLabel":"calling the thread safe function permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Calling the Thread-Safe Function"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Threads may call into JavaScript via "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/nodejs/node-addon-api/blob/main/doc/threadsafe_function.md#blockingcall--nonblockingcall"},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[Non]BlockingCall"}]}]},{"type":"text","value":". This will add an entry to the underlying thread-safe function’s queue, to be handled asynchronously on the main thread during its processing of the event loop."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"thread-management","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#thread-management","ariaLabel":"thread management permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Thread Management"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Multiple threads can utilize the thread-safe function simultaneously. The thread-safe function manages its lifecycle through counting the number of threads actively utilizing it. This number starts at the initial thread count parameter in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"New()"}]},{"type":"text","value":", increased via "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Acquire()"}]},{"type":"text","value":", and decreased via "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Released()"}]},{"type":"text","value":". Once the number of active threads reaches zero, the thread-safe function is destroyed, running the finalizer callback on the main thread if provided."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here are two general approaches to using thread-safe functions within applications:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"known-number-of-threads","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#known-number-of-threads","ariaLabel":"known number of threads permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Known Number of Threads"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If the amount of threads is known at thread-safe function creation, set the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"initial_thread_count"}]},{"type":"text","value":" parameter to this number in the call to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"New()"}]},{"type":"text","value":". Each thread will have its own access to the thread-safe function until it calls "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Release()"}]},{"type":"text","value":". Once all threads have made a call to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Release()"}]},{"type":"text","value":", the thread-safe function is destroyed."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"creating-threads","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#creating-threads","ariaLabel":"creating threads permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Creating Threads"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Another common use-case is to dynamically create and destroy threads based on various logic at run-time. One way to handle this scenario is to expose several native JavaScript functions that interact with the thread-safe function APIs by:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Creating a thread-safe function via "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"New()"}]},{"type":"text","value":" with initial thread count of "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"1"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Calling "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Acquire()"}]},{"type":"text","value":" and creating a new native thread. The new thread can now use "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[Non]BlockingCall()"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Initiating cleanup/destruction, for example by …"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"calling "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Abort()"}]},{"type":"text","value":" and have each thread either call "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[Non]BlockingCall()"}]},{"type":"text","value":" or "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Release()"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"using custom logic with other thread-safe APIs to ensure that all threads call "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Release()"}]},{"type":"text","value":" in order to decrease the active thread count to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"0"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"example","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#example","ariaLabel":"example permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Example"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This example node-addon-api module creates exposes a single function that creates a thread-safe function and a native thread. The function returns a promise that resolves after the native thread calls into JavaScript ten times."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"bindinggyp","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#bindinggyp","ariaLabel":"bindinggyp permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"binding.gyp"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://github.com/nodejs/node-addon-examples/blob/main/thread_safe_function_counting/node-addon-api/binding.gyp"},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"binding.gyp"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"gyp"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-gyp"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-gyp"]},"children":[{"type":"text","value":"{\n  'targets': [{\n    'target_name': 'addon',\n    'defines': ['V8_DEPRECATION_WARNINGS=1'],\n    'sources': ['addon.cc'],\n    'include_dirs': [\"<!@(node -p \\\"require('node-addon-api').include\\\")\"],\n    'dependencies': [\"<!(node -p \\\"require('node-addon-api').gyp\\\")\"],\n    'cflags!': ['-fno-exceptions'],\n    'cflags_cc!': ['-fno-exceptions'],\n    'xcode_settings': {\n      'GCC_ENABLE_CPP_EXCEPTIONS': 'YES',\n      'CLANG_CXX_LIBRARY': 'libc++',\n      'MACOSX_DEPLOYMENT_TARGET': '10.7',\n    },\n    'msvs_settings': {\n      'VCCLCompilerTool': {\n        'ExceptionHandling': 1\n      },\n    },\n  }]\n}"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"addoncc","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#addoncc","ariaLabel":"addoncc permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"addon.cc"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://github.com/nodejs/node-addon-examples/blob/main/thread_safe_function_counting/node-addon-api/addon.cc"},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"addon.cc"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"cc"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-cc"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-cc"]},"children":[{"type":"text","value":"#include <chrono>\n#include <thread>\n#include \"napi.h\"\n\nconstexpr size_t ARRAY_LENGTH = 10;\n\n// Data structure representing our thread-safe function context.\nstruct TsfnContext {\n  TsfnContext(Napi::Env env) : deferred(Napi::Promise::Deferred::New(env)) {\n    for (size_t i = 0; i < ARRAY_LENGTH; ++i) ints[i] = i;\n  };\n\n  // Native Promise returned to JavaScript\n  Napi::Promise::Deferred deferred;\n\n  // Native thread\n  std::thread nativeThread;\n\n  // Some data to pass around\n  int ints[ARRAY_LENGTH];\n\n  Napi::ThreadSafeFunction tsfn;\n};\n\n// The thread entry point. This takes as its arguments the specific\n// threadsafe-function context created inside the main thread.\nvoid threadEntry(TsfnContext* context);\n\n// The thread-safe function finalizer callback. This callback executes\n// at destruction of thread-safe function, taking as arguments the finalizer\n// data and threadsafe-function context.\nvoid FinalizerCallback(Napi::Env env, void* finalizeData, TsfnContext* context);\n\n// Exported JavaScript function. Creates the thread-safe function and native\n// thread. Promise is resolved in the thread-safe function's finalizer.\nNapi::Value CreateTSFN(const Napi::CallbackInfo& info) {\n  Napi::Env env = info.Env();\n\n  // Construct context data\n  auto testData = new TsfnContext(env);\n\n  // Create a new ThreadSafeFunction.\n  testData->tsfn = Napi::ThreadSafeFunction::New(\n      env,                           // Environment\n      info[0].As<Napi::Function>(),  // JS function from caller\n      \"TSFN\",                        // Resource name\n      0,                             // Max queue size (0 = unlimited).\n      1,                             // Initial thread count\n      testData,                      // Context,\n      FinalizerCallback,             // Finalizer\n      (void*)nullptr                 // Finalizer data\n  );\n  testData->nativeThread = std::thread(threadEntry, testData);\n\n  // Return the deferred's Promise. This Promise is resolved in the thread-safe\n  // function's finalizer callback.\n  return testData->deferred.Promise();\n}\n\n// The thread entry point. This takes as its arguments the specific\n// threadsafe-function context created inside the main thread.\nvoid threadEntry(TsfnContext* context) {\n  // This callback transforms the native addon data (int *data) to JavaScript\n  // values. It also receives the treadsafe-function's registered callback, and\n  // may choose to call it.\n  auto callback = [](Napi::Env env, Napi::Function jsCallback, int* data) {\n    jsCallback.Call({Napi::Number::New(env, *data)});\n  };\n\n  for (size_t index = 0; index < ARRAY_LENGTH; ++index) {\n    // Perform a call into JavaScript.\n    napi_status status =\n        context->tsfn.BlockingCall(&context->ints[index], callback);\n\n    if (status != napi_ok) {\n      Napi::Error::Fatal(\n          \"ThreadEntry\",\n          \"Napi::ThreadSafeNapi::Function.BlockingCall() failed\");\n    }\n    // Sleep for some time.\n    std::this_thread::sleep_for(std::chrono::milliseconds(200));\n  }\n\n  // Release the thread-safe function. This decrements the internal thread\n  // count, and will perform finalization since the count will reach 0.\n  context->tsfn.Release();\n}\n\nvoid FinalizerCallback(Napi::Env env,\n                       void* finalizeData,\n                       TsfnContext* context) {\n  // Join the thread\n  context->nativeThread.join();\n\n  // Resolve the Promise previously returned to JS via the CreateTSFN method.\n  context->deferred.Resolve(Napi::Boolean::New(env, true));\n  delete context;\n}\n\n// Addon entry point\nNapi::Object Init(Napi::Env env, Napi::Object exports) {\n  exports[\"createTSFN\"] = Napi::Function::New(env, CreateTSFN);\n  return exports;\n}\n\nNODE_API_MODULE(addon, Init)"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"addonjs","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#addonjs","ariaLabel":"addonjs permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"addon.js"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://github.com/nodejs/node-addon-examples/blob/main/thread_safe_function_counting/node-addon-api/addon.js"},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"addon.js"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"jsx"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-jsx"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-jsx"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" createTSFN "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"require"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'bindings'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'addon'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function-variable","function"]},"children":[{"type":"text","value":"callback"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"args"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"=>"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":" \n    console"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"log"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Date"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"..."}]},{"type":"text","value":"args"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" \n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"void"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"async"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"function"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    console"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"log"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"await"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"createTSFN"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"callback"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Running the above script will provide output similar to:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"text"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-text"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"2019-11-25T22:14:56.175Z 0\n2019-11-25T22:14:56.380Z 1\n2019-11-25T22:14:56.582Z 2\n2019-11-25T22:14:56.787Z 3\n2019-11-25T22:14:56.987Z 4\n2019-11-25T22:14:57.187Z 5\n2019-11-25T22:14:57.388Z 6\n2019-11-25T22:14:57.591Z 7\n2019-11-25T22:14:57.796Z 8\n2019-11-25T22:14:58.001Z 9\ntrue"}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"frequently-asked-questions","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#frequently-asked-questions","ariaLabel":"frequently asked questions permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Frequently Asked Questions"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"q-my-application-isnt-exiting-correctly-it-just-hangs","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#q-my-application-isnt-exiting-correctly-it-just-hangs","ariaLabel":"q my application isnt exiting correctly it just hangs permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Q: My application isn’t exiting correctly. It just hangs."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"By default, Node will wait until a thread-safe function is finalized before cleaning up and exiting. See "},{"type":"element","tagName":"a","properties":{"href":"#Thread-Management"},"children":[{"type":"text","value":"Thread Management"}]},{"type":"text","value":". This behavior can be changed via a call to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Unref()"}]},{"type":"text","value":", permitting Node to clean up without waiting for the thread count to reach zero. A call to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Ref()"}]},{"type":"text","value":" will will return the threadsafe function to the previous exit behavior, requiring it to be "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Release()"}]},{"type":"text","value":"ed and/or "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Abort()"}]},{"type":"text","value":"ed by all threads utilizing it."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"q-if-a-thread-receives-code-classlanguage-textnapi_closingcode-from-a-call-to-code-classlanguage-textnonblockingcallcode-does-it-still-need-to-call-code-classlanguage-textreleasecode","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#q-if-a-thread-receives-code-classlanguage-textnapi_closingcode-from-a-call-to-code-classlanguage-textnonblockingcallcode-does-it-still-need-to-call-code-classlanguage-textreleasecode","ariaLabel":"q if a thread receives code classlanguage textnapi_closingcode from a call to code classlanguage textnonblockingcallcode does it still need to call code classlanguage textreleasecode permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Q: If a thread receives "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"napi_closing"}]},{"type":"text","value":" from a call to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"[Non]BlockingCall()"}]},{"type":"text","value":", does it still need to call "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Release()"}]},{"type":"text","value":"?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"No. A return value of "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"napi_closing"}]},{"type":"text","value":" should signify to the thread that the thread-safe function can no longer be utilized. This "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"includes"}]},{"type":"text","value":" the call to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Release()"}]},{"type":"text","value":"."}]}],"data":{"quirksMode":false}},"tableOfContents":"<ul>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#calling-the-thread-safe-function\">Calling the Thread-Safe Function</a></li>\n<li>\n<p><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#thread-management\">Thread Management</a></p>\n<ul>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#known-number-of-threads\">Known Number of Threads</a></li>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#creating-threads\">Creating Threads</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#example\">Example</a></p>\n<ul>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#bindinggyp\">binding.gyp</a></li>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#addoncc\">addon.cc</a></li>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#addonjs\">addon.js</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#frequently-asked-questions\">Frequently Asked Questions</a></p>\n<ul>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#q-my-application-isnt-exiting-correctly-it-just-hangs\">Q: My application isn’t exiting correctly. It just hangs.</a></li>\n<li><a href=\"/node-addon-examples/special-topics/thread-safe-functions/#q-if-a-thread-receives-code-classlanguage-textnapi_closingcode-from-a-call-to-code-classlanguage-textnonblockingcallcode-does-it-still-need-to-call-code-classlanguage-textreleasecode\">Q: If a thread receives <code class=\"language-text\">napi_closing</code> from a call to <code class=\"language-text\">[Non]BlockingCall()</code>, does it still need to call <code class=\"language-text\">Release()</code>?</a></li>\n</ul>\n</li>\n</ul>","excerpt":"JavaScript functions can normally only be called from a native addon’s main thread. If an addon creates additional threads, then node-addon…","frontmatter":{"id":"special-topics.thread-safe-functions","title":"Thread-safe functions","prev":"special-topics.asyncworker","next":"special-topics.context-awareness"}}},"pageContext":{"slug":"/special-topics/thread-safe-functions/"}},"staticQueryHashes":["1919669498","757746438"]}